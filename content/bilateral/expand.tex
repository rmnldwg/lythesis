\providecommand{\relativeRoot}{../..}
\documentclass[\relativeRoot/main.tex]{subfiles}


\begin{document}

\section{Expanding the unilateral model}
\label{sec:bilateral:expand}

If we start by dissecting this joint conditional probability in the following way
%
\begin{equation} \label{eq:hmm_bilateral_bayes}
    P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \mid \mathbf{Z}^\text{i}, \mathbf{Z}^\text{c} \right) = \frac{P \left( \mathbf{Z}^\text{i}, \mathbf{Z}^\text{c} \mid \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \right) \cdot P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \right)}{P \left( \mathbf{Z}^\text{i}, \mathbf{Z}^\text{c} \right)}
\end{equation}
%
we notice right away that the likelihood on the right factorizes: Given the true states of involvement in the two sides of the neck, their respective diagnoses must be independent. Furthermore, the two factors are already given by their corresponding observation matrices $\mathbf{B}^\text{i}$ and $\mathbf{B}^\text{c}$.

The joint probability of the hidden states $P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \right)$ does not factorize in the same manner. But if we assume the lymphatic network to be symmetric and directed, there can be no direct connection between \glspl{lnl} of the two sides of the neck, which means the probability for involvement of the ipsi- and contralateral side only correlate via the diagnose time $t$. Hence the joint probability is a sum of factorizing terms:
%
\begin{equation} \label{eq:bilateral:expand:dissect}
    \begin{aligned}
        P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \right) &= \sum_{t \in \mathbb{T}}{ p(t) \cdot P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \mid t \right)} \\
        &= \sum_{t \in \mathbb{T}}{ p(t) \cdot P \big( \mathbf{X}^\text{c} \mid t \big) \cdot P^\top \big( \mathbf{X}^\text{i} \mid t \big)}
    \end{aligned}
\end{equation}
%
Note that the two row vectors of probabilities in the second line are multiplied using an outer product. Using the notation from the last section, We can write this in an algebraic way to effectively factorize this sum as follows
%
\begin{equation} \label{eq:bilateral:expand:algebra}
    P \left( \mathbf{X}^\text{c} = \boldsymbol{\xi}_n, \mathbf{X}^\text{i} = \boldsymbol{\xi}_m \right) = \left[ \boldsymbol{\Lambda}_\text{c}^\top \cdot \operatorname{diag}{p(\mathbf{t})} \cdot \boldsymbol{\Lambda}_\text{i} \right]_{n,m}
\end{equation}
%
where the $\boldsymbol{\Lambda}$ are again matrices with rows of the conditional probabilities $P \left( \mathbf{X} \mid t \right)$ which can be computed as defined in \cref{eq:hmm_matrix_lambda}. Multiplying these two matrices -- one, transposed, for the contralateral side from the left and one for the ipsilateral side from the right -- onto a diagonal matrix containing the time prior marginalizes over the diagnosis time and results in a matrix where the value in row $n$ and column $m$ represents the probability to find the contralateral neck in state $\mathbf{X}^\text{c} = \boldsymbol{\xi}_n$ and the ipsilateral lymphatic system in state $\mathbf{X}^\text{i} = \boldsymbol{\xi}_m$.

Similarily, we can now multiply the observation matrices $\mathbf{B}$ from the left and the right onto $P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \right)$ to compute the bilateral equivalent of \cref{eq:unilateral:hmm_marginalize}:
%
\begin{equation} \label{eq:bilateral:expand:observation}
    P \left( \mathbf{Z}^\text{c} = \boldsymbol{\zeta}_n, \mathbf{Z}^\text{i} = \boldsymbol{\zeta}_m \right) = \left[ \mathbf{B}^\top \cdot \boldsymbol{\Lambda}_\text{c}^\top \cdot \operatorname{diag}{p(\mathbf{t})} \cdot \boldsymbol{\Lambda}_\text{i} \cdot \mathbf{B} \right]_{n,m}
\end{equation}
%
Formally, all necessary terms can now be computed so that both inference and the subsequent risk prediction can be performed. However, in the next section we will go into more detail regarding how this was implemented.

\end{document}